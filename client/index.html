<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS Video Client</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:20px}
    .hidden{display:none}
    #log{white-space:pre-wrap;background:#f7f7f7;border:1px solid #ddd;padding:10px;height:150px;overflow:auto}
    .row{margin-bottom:12px}
  </style>
</head>
<body>
  <h3>WebSocket Video Client</h3>

  <div id="connectBox" class="row">
    <input id="username" placeholder="Имя пользователя" />
    <button id="connectBtn">Connect</button>
    <span id="status">● Disconnected</span>
  </div>

  <div id="playerBox" class="row">
    <video id="video" controls width="640" preload="none" muted>
      <source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <div class="row">
    <button id="pingBtn" disabled>Send ping</button>
  </div>

  <h4>Log</h4>
  <div id="log"></div>

  <script>
    // ----- Настройка: укажи адрес WebSocket сервера -----
    const WS_URL = "ws://localhost:8080/pingpong"; // <- поменяй при необходимости
    // --------------------------------------------------

    const usernameInput = document.getElementById("username");
    const connectBtn = document.getElementById("connectBtn");
    const statusEl = document.getElementById("status");
    const playerBox = document.getElementById("playerBox");
    const videoEl = document.getElementById("video");
    const pingBtn = document.getElementById("pingBtn");
    const logEl = document.getElementById("log");

    let ws = null;
    let connectionId = null;

    function log(...args){
      const line = args.map(a => (typeof a === "object" ? JSON.stringify(a) : String(a))).join(" ");
      logEl.textContent += line + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(...args);
    }

    function genConnectionId(){
      if (crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
      // fallback UUID v4
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function setStatus(text, color = "black"){
      statusEl.textContent = text;
      statusEl.style.color = color;
    }

    connectBtn.addEventListener("click", () => {
      const username = (usernameInput.value || "").trim();
      if (!username) { alert("Введите username"); return; }
      connectBtn.disabled = true;
      connect(username);
    });

    function connect(username){
      connectionId = genConnectionId();
      ws = new WebSocket(WS_URL);

      ws.addEventListener("open", () => {
        setStatus("● Connected", "green");
        log("[WS] open, sending init user JSON");
        // Отправляем JSON с полями, которые сервер ожидает при инициализации
        const userInit = { ConnectionId: connectionId, Username: username };
        ws.send(JSON.stringify(userInit));
        log("[WS] sent init:", userInit);
        playerBox.classList.remove("hidden");
        pingBtn.disabled = false;
      });

      ws.addEventListener("message", (ev) => {
        log("[WS] message:", ev.data);

        if (ev.data === "pong") {
            log("[WS] received pong");
        } else if (ev.data === "play") {
            log("[WS] received play → starting video");
            videoEl.play().catch(err => {
            log("❗ Ошибка автозапуска видео:", err);
            });
        }
      });

      ws.addEventListener("close", (ev) => {
        setStatus("● Disconnected", "red");
        log("[WS] closed", ev);
        pingBtn.disabled = true;
        connectBtn.disabled = false;
      });

      ws.addEventListener("error", (ev) => {
        setStatus("● Error", "orange");
        log("[WS] error", ev);
      });
    }

    // Когда пользователь нажимает Play — отправляем "play" (срок ожидания init покрыт сервером)
    videoEl.addEventListener("play", () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log("[Client] WS not connected — cannot send play");
        return;
      }
      log("[Client] video play -> sending 'play' to server");
      ws.send("play");
    });

    // Для теста ping/pong
    pingBtn.addEventListener("click", () => {
      if (!ws || ws.readyState !== WebSocket.OPEN) { log("WS not open"); return; }
      ws.send("ping");
      log("Sent ping");
    });

    // Закрыть соединение при уходе со страницы
    window.addEventListener("beforeunload", () => {
      if (ws && ws.readyState === WebSocket.OPEN) ws.close();
    });
  </script>
</body>
</html>
